0000000000000000000000000000000000000000;;	#!/bin/bash
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# Copyright 2015 The Kubernetes Authors.
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	# Licensed under the Apache License, Version 2.0 (the "License");
0000000000000000000000000000000000000000;;	# you may not use this file except in compliance with the License.
0000000000000000000000000000000000000000;;	# You may obtain a copy of the License at
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	#     http://www.apache.org/licenses/LICENSE-2.0
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	# Unless required by applicable law or agreed to in writing, software
0000000000000000000000000000000000000000;;	# distributed under the License is distributed on an "AS IS" BASIS,
0000000000000000000000000000000000000000;;	# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
0000000000000000000000000000000000000000;;	# See the License for the specific language governing permissions and
0000000000000000000000000000000000000000;;	# limitations under the License.
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# 
0000000000000000000000000000000000000000;;	# This script does the following:
0000000000000000000000000000000000000000;;	# 
0000000000000000000000000000000000000000;;	# 1. Sets up database privileges by building an SQL script
0000000000000000000000000000000000000000;;	# 2. MySQL is initially started with this script a first time 
0000000000000000000000000000000000000000;;	# 3. Modify my.cnf and cluster.cnf to reflect available nodes to join
0000000000000000000000000000000000000000;;	# 
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# if NUM_NODES not passed, default to 3
0000000000000000000000000000000000000000;;	if [ -z "$NUM_NODES" ]; then
0000000000000000000000000000000000000000;;	  NUM_NODES=3
0000000000000000000000000000000000000000;;	fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	if [ "${1:0:1}" = '-' ]; then
0000000000000000000000000000000000000000;;	  set -- mysqld "$@"
0000000000000000000000000000000000000000;;	fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# if the command passed is 'mysqld' via CMD, then begin processing. 
0000000000000000000000000000000000000000;;	if [ "$1" = 'mysqld' ]; then
0000000000000000000000000000000000000000;;	  # read DATADIR from the MySQL config
0000000000000000000000000000000000000000;;	  DATADIR="$("$@" --verbose --help 2>/dev/null | awk '$1 == "datadir" { print $2; exit }')"
0000000000000000000000000000000000000000;;	 
0000000000000000000000000000000000000000;;	  # only check if system tables not created from mysql_install_db and permissions 
0000000000000000000000000000000000000000;;	  # set with initial SQL script before proceeding to build SQL script
0000000000000000000000000000000000000000;;	  if [ ! -d "$DATADIR/mysql" ]; then
0000000000000000000000000000000000000000;;	  # fail if user didn't supply a root password  
0000000000000000000000000000000000000000;;	    if [ -z "$MYSQL_ROOT_PASSWORD" -a -z "$MYSQL_ALLOW_EMPTY_PASSWORD" ]; then
0000000000000000000000000000000000000000;;	      echo >&2 'error: database is uninitialized and MYSQL_ROOT_PASSWORD not set'
0000000000000000000000000000000000000000;;	      echo >&2 '  Did you forget to add -e MYSQL_ROOT_PASSWORD=... ?'
0000000000000000000000000000000000000000;;	      exit 1
0000000000000000000000000000000000000000;;	    fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	    # mysql_install_db installs system tables
0000000000000000000000000000000000000000;;	    echo 'Running mysql_install_db ...'
0000000000000000000000000000000000000000;;	        mysql_install_db --datadir="$DATADIR"
0000000000000000000000000000000000000000;;	        echo 'Finished mysql_install_db'
0000000000000000000000000000000000000000;;	    
0000000000000000000000000000000000000000;;	    # this script will be run once when MySQL first starts to set up
0000000000000000000000000000000000000000;;	    # prior to creating system tables and will ensure proper user permissions 
0000000000000000000000000000000000000000;;	    tempSqlFile='/tmp/mysql-first-time.sql'
0000000000000000000000000000000000000000;;	    cat > "$tempSqlFile" <<-EOSQL
0000000000000000000000000000000000000000;;	DELETE FROM mysql.user ;
0000000000000000000000000000000000000000;;	CREATE USER 'root'@'%' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}' ;
0000000000000000000000000000000000000000;;	GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION ;
0000000000000000000000000000000000000000;;	EOSQL
0000000000000000000000000000000000000000;;	    
0000000000000000000000000000000000000000;;	    if [ "$MYSQL_DATABASE" ]; then
0000000000000000000000000000000000000000;;	      echo "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\` ;" >> "$tempSqlFile"
0000000000000000000000000000000000000000;;	    fi
0000000000000000000000000000000000000000;;	    
0000000000000000000000000000000000000000;;	    if [ "$MYSQL_USER" -a "$MYSQL_PASSWORD" ]; then
0000000000000000000000000000000000000000;;	      echo "CREATE USER '$MYSQL_USER'@'%' IDENTIFIED BY '$MYSQL_PASSWORD' ;" >> "$tempSqlFile"
0000000000000000000000000000000000000000;;	      
0000000000000000000000000000000000000000;;	      if [ "$MYSQL_DATABASE" ]; then
0000000000000000000000000000000000000000;;	        echo "GRANT ALL ON \`$MYSQL_DATABASE\`.* TO '$MYSQL_USER'@'%' ;" >> "$tempSqlFile"
0000000000000000000000000000000000000000;;	      fi
0000000000000000000000000000000000000000;;	    fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	    # Add SST (Single State Transfer) user if Clustering is turned on
0000000000000000000000000000000000000000;;	    if [ -n "$GALERA_CLUSTER" ]; then
0000000000000000000000000000000000000000;;	    # this is the Single State Transfer user (SST, initial dump or xtrabackup user)
0000000000000000000000000000000000000000;;	      WSREP_SST_USER=${WSREP_SST_USER:-"sst"}
0000000000000000000000000000000000000000;;	      if [ -z "$WSREP_SST_PASSWORD" ]; then
0000000000000000000000000000000000000000;;	        echo >&2 'error: Galera cluster is enabled and WSREP_SST_PASSWORD is not set'
0000000000000000000000000000000000000000;;	        echo >&2 '  Did you forget to add -e WSREP_SST__PASSWORD=... ?'
0000000000000000000000000000000000000000;;	        exit 1
0000000000000000000000000000000000000000;;	      fi
0000000000000000000000000000000000000000;;	      # add single state transfer (SST) user privileges
0000000000000000000000000000000000000000;;	      echo "CREATE USER '${WSREP_SST_USER}'@'localhost' IDENTIFIED BY '${WSREP_SST_PASSWORD}';" >> "$tempSqlFile"
0000000000000000000000000000000000000000;;	      echo "GRANT RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO '${WSREP_SST_USER}'@'localhost';" >> "$tempSqlFile"
0000000000000000000000000000000000000000;;	    fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	    echo 'FLUSH PRIVILEGES ;' >> "$tempSqlFile"
0000000000000000000000000000000000000000;;	    
0000000000000000000000000000000000000000;;	    # Add the SQL file to mysqld's command line args
0000000000000000000000000000000000000000;;	    set -- "$@" --init-file="$tempSqlFile"
0000000000000000000000000000000000000000;;	  fi
0000000000000000000000000000000000000000;;	  
0000000000000000000000000000000000000000;;	  chown -R mysql:mysql "$DATADIR"
0000000000000000000000000000000000000000;;	fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# if cluster is turned on, then proceed to build cluster setting strings
0000000000000000000000000000000000000000;;	# that will be interpolated into the config files
0000000000000000000000000000000000000000;;	if [ -n "$GALERA_CLUSTER" ]; then
0000000000000000000000000000000000000000;;	  # this is the Single State Transfer user (SST, initial dump or xtrabackup user)
0000000000000000000000000000000000000000;;	  WSREP_SST_USER=${WSREP_SST_USER:-"sst"}
0000000000000000000000000000000000000000;;	  if [ -z "$WSREP_SST_PASSWORD" ]; then
0000000000000000000000000000000000000000;;	    echo >&2 'error: database is uninitialized and WSREP_SST_PASSWORD not set'
0000000000000000000000000000000000000000;;	    echo >&2 '  Did you forget to add -e WSREP_SST_PASSWORD=xxx ?'
0000000000000000000000000000000000000000;;	    exit 1
0000000000000000000000000000000000000000;;	  fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	  # user/password for SST user
0000000000000000000000000000000000000000;;	  sed -i -e "s|^wsrep_sst_auth=sstuser:changethis|wsrep_sst_auth=${WSREP_SST_USER}:${WSREP_SST_PASSWORD}|" /etc/mysql/conf.d/cluster.cnf
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	  # set nodes own address
0000000000000000000000000000000000000000;;	  WSREP_NODE_ADDRESS=`ip addr show | grep -E '^[ ]*inet' | grep -m1 global | awk '{ print $2 }' | sed -e 's/\/.*//'`
0000000000000000000000000000000000000000;;	  if [ -n "$WSREP_NODE_ADDRESS" ]; then
0000000000000000000000000000000000000000;;	    sed -i -e "s|^wsrep_node_address=.*$|wsrep_node_address=${WSREP_NODE_ADDRESS}|" /etc/mysql/conf.d/cluster.cnf
0000000000000000000000000000000000000000;;	  fi
0000000000000000000000000000000000000000;;	  
0000000000000000000000000000000000000000;;	  # if the string is not defined or it only is 'gcomm://', this means bootstrap
0000000000000000000000000000000000000000;;	  if [ -z "$WSREP_CLUSTER_ADDRESS" -o "$WSREP_CLUSTER_ADDRESS" == "gcomm://" ]; then
0000000000000000000000000000000000000000;;	    # if empty, set to 'gcomm://'
0000000000000000000000000000000000000000;;	    # NOTE: this list does not imply membership. 
0000000000000000000000000000000000000000;;	    # It only means "obtain SST and join from one of these..."
0000000000000000000000000000000000000000;;	    if [ -z "$WSREP_CLUSTER_ADDRESS" ]; then
0000000000000000000000000000000000000000;;	      WSREP_CLUSTER_ADDRESS="gcomm://"
0000000000000000000000000000000000000000;;	    fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	    # loop through number of nodes
0000000000000000000000000000000000000000;;	    for NUM in `seq 1 $NUM_NODES`; do
0000000000000000000000000000000000000000;;	      NODE_SERVICE_HOST="PXC_NODE${NUM}_SERVICE_HOST"
0000000000000000000000000000000000000000;;	  
0000000000000000000000000000000000000000;;	      # if set
0000000000000000000000000000000000000000;;	      if [ -n "${!NODE_SERVICE_HOST}" ]; then
0000000000000000000000000000000000000000;;	        # if not its own IP, then add it
0000000000000000000000000000000000000000;;	        if [ $(expr "$HOSTNAME" : "pxc-node${NUM}") -eq 0 ]; then
0000000000000000000000000000000000000000;;	          # if not the first bootstrap node add comma
0000000000000000000000000000000000000000;;	          if [ $WSREP_CLUSTER_ADDRESS != "gcomm://" ]; then
0000000000000000000000000000000000000000;;	            WSREP_CLUSTER_ADDRESS="${WSREP_CLUSTER_ADDRESS},"
0000000000000000000000000000000000000000;;	          fi
0000000000000000000000000000000000000000;;	          # append
0000000000000000000000000000000000000000;;	          # if user specifies USE_IP, use that
0000000000000000000000000000000000000000;;	          if [ -n "${USE_IP}" ]; then
0000000000000000000000000000000000000000;;	            WSREP_CLUSTER_ADDRESS="${WSREP_CLUSTER_ADDRESS}"${!NODE_SERVICE_HOST}
0000000000000000000000000000000000000000;;	          # otherwise use DNS
0000000000000000000000000000000000000000;;	          else
0000000000000000000000000000000000000000;;	            WSREP_CLUSTER_ADDRESS="${WSREP_CLUSTER_ADDRESS}pxc-node${NUM}"
0000000000000000000000000000000000000000;;	          fi
0000000000000000000000000000000000000000;;	        fi
0000000000000000000000000000000000000000;;	      fi
0000000000000000000000000000000000000000;;	    done
0000000000000000000000000000000000000000;;	  fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	  # WSREP_CLUSTER_ADDRESS is now complete and will be interpolated into the 
0000000000000000000000000000000000000000;;	  # cluster address string (wsrep_cluster_address) in the cluster
0000000000000000000000000000000000000000;;	  # configuration file, cluster.cnf
0000000000000000000000000000000000000000;;	  if [ -n "$WSREP_CLUSTER_ADDRESS" -a "$WSREP_CLUSTER_ADDRESS" != "gcomm://" ]; then
0000000000000000000000000000000000000000;;	    sed -i -e "s|^wsrep_cluster_address=gcomm://|wsrep_cluster_address=${WSREP_CLUSTER_ADDRESS}|" /etc/mysql/conf.d/cluster.cnf
0000000000000000000000000000000000000000;;	  fi
0000000000000000000000000000000000000000;;	fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# random server ID needed
0000000000000000000000000000000000000000;;	sed -i -e "s/^server\-id=.*$/server-id=${RANDOM}/" /etc/mysql/my.cnf
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# finally, start mysql 
0000000000000000000000000000000000000000;;	exec "$@"
