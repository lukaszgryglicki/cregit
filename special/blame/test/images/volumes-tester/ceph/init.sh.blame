0000000000000000000000000000000000000000;;	#!/bin/bash
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# Copyright 2015 The Kubernetes Authors.
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	# Licensed under the Apache License, Version 2.0 (the "License");
0000000000000000000000000000000000000000;;	# you may not use this file except in compliance with the License.
0000000000000000000000000000000000000000;;	# You may obtain a copy of the License at
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	#     http://www.apache.org/licenses/LICENSE-2.0
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	# Unless required by applicable law or agreed to in writing, software
0000000000000000000000000000000000000000;;	# distributed under the License is distributed on an "AS IS" BASIS,
0000000000000000000000000000000000000000;;	# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
0000000000000000000000000000000000000000;;	# See the License for the specific language governing permissions and
0000000000000000000000000000000000000000;;	# limitations under the License.
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	#set -e
0000000000000000000000000000000000000000;;	set -x
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# clean up
0000000000000000000000000000000000000000;;	rm -f /etc/ceph/*
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	pkill -9 ceph-mon
0000000000000000000000000000000000000000;;	pkill -9 ceph-osd
0000000000000000000000000000000000000000;;	pkill -9 ceph-mds
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	mkdir -p /var/lib/ceph
0000000000000000000000000000000000000000;;	mkdir -p /var/lib/ceph/osd
0000000000000000000000000000000000000000;;	mkdir -p /var/lib/ceph/osd/ceph-0
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# create hostname for ceph monitor
0000000000000000000000000000000000000000;;	MASTER=`hostname -s`
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	ip=$(ip -4 -o a | grep eth0 | awk '{print $4}' | cut -d'/' -f1)
0000000000000000000000000000000000000000;;	echo "$ip $MASTER" >> /etc/hosts
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	#create ceph cluster
0000000000000000000000000000000000000000;;	ceph-deploy --overwrite-conf new ${MASTER}  
0000000000000000000000000000000000000000;;	ceph-deploy --overwrite-conf mon create-initial ${MASTER}
0000000000000000000000000000000000000000;;	ceph-deploy --overwrite-conf mon create ${MASTER}
0000000000000000000000000000000000000000;;	ceph-deploy  gatherkeys ${MASTER}  
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# set osd  params for minimal configuration
0000000000000000000000000000000000000000;;	echo "osd crush chooseleaf type = 0" >> /etc/ceph/ceph.conf
0000000000000000000000000000000000000000;;	echo "osd journal size = 100" >> /etc/ceph/ceph.conf
0000000000000000000000000000000000000000;;	echo "osd pool default size = 1" >> /etc/ceph/ceph.conf
0000000000000000000000000000000000000000;;	echo "osd pool default pgp num = 8" >> /etc/ceph/ceph.conf
0000000000000000000000000000000000000000;;	echo "osd pool default pg num = 8" >> /etc/ceph/ceph.conf
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	/sbin/service ceph -c /etc/ceph/ceph.conf stop mon.${MASTER}
0000000000000000000000000000000000000000;;	/sbin/service ceph -c /etc/ceph/ceph.conf start mon.${MASTER}
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# create ceph osd
0000000000000000000000000000000000000000;;	ceph osd create
0000000000000000000000000000000000000000;;	ceph-osd -i 0 --mkfs --mkkey
0000000000000000000000000000000000000000;;	ceph auth add osd.0 osd 'allow *' mon 'allow rwx' -i /var/lib/ceph/osd/ceph-0/keyring
0000000000000000000000000000000000000000;;	ceph osd crush add 0 1 root=default host=${MASTER}
0000000000000000000000000000000000000000;;	ceph-osd -i 0 -k /var/lib/ceph/osd/ceph-0/keyring
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	#see if we are ready to go  
0000000000000000000000000000000000000000;;	ceph osd tree  
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# create ceph fs
0000000000000000000000000000000000000000;;	ceph osd pool create cephfs_data 4
0000000000000000000000000000000000000000;;	ceph osd pool create cephfs_metadata 4
0000000000000000000000000000000000000000;;	ceph fs new cephfs cephfs_metadata cephfs_data
0000000000000000000000000000000000000000;;	ceph-deploy --overwrite-conf mds create ${MASTER}
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# uncomment the following for rbd test
0000000000000000000000000000000000000000;;	# ceph osd pool create kube 4
0000000000000000000000000000000000000000;;	# rbd create foo --size 10 --pool kube
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	ps -ef |grep ceph
0000000000000000000000000000000000000000;;	ceph osd dump
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# add new client with a pre defined keyring
0000000000000000000000000000000000000000;;	# this keyring must match the ceph secret in e2e test
0000000000000000000000000000000000000000;;	cat > /etc/ceph/ceph.client.kube.keyring <<EOF
0000000000000000000000000000000000000000;;	[client.kube]
0000000000000000000000000000000000000000;;	        key = AQAMgXhVwBCeDhAA9nlPaFyfUSatGD4drFWDvQ==
0000000000000000000000000000000000000000;;	        caps mds = "allow rwx"
0000000000000000000000000000000000000000;;	        caps mon = "allow rwx"
0000000000000000000000000000000000000000;;	        caps osd = "allow rwx"
0000000000000000000000000000000000000000;;	EOF
0000000000000000000000000000000000000000;;	ceph auth import -i /etc/ceph/ceph.client.kube.keyring
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# mount it through ceph-fuse and copy file to ceph fs
0000000000000000000000000000000000000000;;	ceph-fuse -m ${MASTER}:6789 /mnt
0000000000000000000000000000000000000000;;	cp /tmp/index.html /mnt
0000000000000000000000000000000000000000;;	chmod 644 /mnt/index.html
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# watch
0000000000000000000000000000000000000000;;	ceph -w
