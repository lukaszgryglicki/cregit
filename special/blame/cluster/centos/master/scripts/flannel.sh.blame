0000000000000000000000000000000000000000;;	#!/bin/bash
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# Copyright 2014 The Kubernetes Authors.
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	# Licensed under the Apache License, Version 2.0 (the "License");
0000000000000000000000000000000000000000;;	# you may not use this file except in compliance with the License.
0000000000000000000000000000000000000000;;	# You may obtain a copy of the License at
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	#     http://www.apache.org/licenses/LICENSE-2.0
0000000000000000000000000000000000000000;;	#
0000000000000000000000000000000000000000;;	# Unless required by applicable law or agreed to in writing, software
0000000000000000000000000000000000000000;;	# distributed under the License is distributed on an "AS IS" BASIS,
0000000000000000000000000000000000000000;;	# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
0000000000000000000000000000000000000000;;	# See the License for the specific language governing permissions and
0000000000000000000000000000000000000000;;	# limitations under the License.
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	ETCD_SERVERS=${1:-"http://8.8.8.18:4001"}
0000000000000000000000000000000000000000;;	FLANNEL_NET=${2:-"172.16.0.0/16"}
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	CA_FILE="/srv/kubernetes/etcd/ca.pem"
0000000000000000000000000000000000000000;;	CERT_FILE="/srv/kubernetes/etcd/client.pem"
0000000000000000000000000000000000000000;;	KEY_FILE="/srv/kubernetes/etcd/client-key.pem"
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	cat <<EOF >/opt/kubernetes/cfg/flannel
0000000000000000000000000000000000000000;;	FLANNEL_ETCD="-etcd-endpoints=${ETCD_SERVERS}"
0000000000000000000000000000000000000000;;	FLANNEL_ETCD_KEY="-etcd-prefix=/coreos.com/network"
0000000000000000000000000000000000000000;;	FLANNEL_ETCD_CAFILE="--etcd-cafile=${CA_FILE}"
0000000000000000000000000000000000000000;;	FLANNEL_ETCD_CERTFILE="--etcd-certfile=${CERT_FILE}"
0000000000000000000000000000000000000000;;	FLANNEL_ETCD_KEYFILE="--etcd-keyfile=${KEY_FILE}"
0000000000000000000000000000000000000000;;	EOF
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	cat <<EOF >/usr/lib/systemd/system/flannel.service
0000000000000000000000000000000000000000;;	[Unit]
0000000000000000000000000000000000000000;;	Description=Flanneld overlay address etcd agent
0000000000000000000000000000000000000000;;	After=network.target
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	[Service]
0000000000000000000000000000000000000000;;	EnvironmentFile=-/opt/kubernetes/cfg/flannel
0000000000000000000000000000000000000000;;	ExecStart=/opt/kubernetes/bin/flanneld --ip-masq \${FLANNEL_ETCD} \${FLANNEL_ETCD_KEY} \${FLANNEL_ETCD_CAFILE} \${FLANNEL_ETCD_CERTFILE} \${FLANNEL_ETCD_KEYFILE}
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	Type=notify
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	[Install]
0000000000000000000000000000000000000000;;	WantedBy=multi-user.target
0000000000000000000000000000000000000000;;	EOF
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	# Store FLANNEL_NET to etcd.
0000000000000000000000000000000000000000;;	attempt=0
0000000000000000000000000000000000000000;;	while true; do
0000000000000000000000000000000000000000;;	  /opt/kubernetes/bin/etcdctl --ca-file ${CA_FILE} --cert-file ${CERT_FILE} --key-file ${KEY_FILE} \
0000000000000000000000000000000000000000;;	    --no-sync -C ${ETCD_SERVERS} \
0000000000000000000000000000000000000000;;	    get /coreos.com/network/config >/dev/null 2>&1
0000000000000000000000000000000000000000;;	  if [[ "$?" == 0 ]]; then
0000000000000000000000000000000000000000;;	    break
0000000000000000000000000000000000000000;;	  else
0000000000000000000000000000000000000000;;	    if (( attempt > 600 )); then
0000000000000000000000000000000000000000;;	      echo "timeout for waiting network config" > ~/kube/err.log
0000000000000000000000000000000000000000;;	      exit 2
0000000000000000000000000000000000000000;;	    fi
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	    /opt/kubernetes/bin/etcdctl --ca-file ${CA_FILE} --cert-file ${CERT_FILE} --key-file ${KEY_FILE} \
0000000000000000000000000000000000000000;;	      --no-sync -C ${ETCD_SERVERS} \
0000000000000000000000000000000000000000;;	      mk /coreos.com/network/config "{\"Network\":\"${FLANNEL_NET}\"}" >/dev/null 2>&1
0000000000000000000000000000000000000000;;	    attempt=$((attempt+1))
0000000000000000000000000000000000000000;;	    sleep 3
0000000000000000000000000000000000000000;;	  fi
0000000000000000000000000000000000000000;;	done
0000000000000000000000000000000000000000;;	wait
0000000000000000000000000000000000000000;;	
0000000000000000000000000000000000000000;;	systemctl enable flannel
0000000000000000000000000000000000000000;;	systemctl daemon-reload
0000000000000000000000000000000000000000;;	systemctl restart flannel
